name: Extract Changes

on:
  push:
    paths:
      - 'CPI_Artifacts_Metadata.txt'

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        id: step0
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Changes
        id: step1
        run: |
          echo "ðŸ” Extracting added lines from modified files..."
          git diff HEAD^ HEAD --ignore-matching-lines='^Timestamp:' -- CPI_Artifacts_Metadata.txt > diff.txt
          echo "ðŸ“„ Diff output saved to diff.txt"
          echo "ðŸ“¥ Extracting Added/Deleted/Changed lines..."
          grep '^+' diff.txt | grep -v '^+++' | sed 's/^+//' > added_lines.txt
          echo "âœ… Added/Deleted/Changed lines extracted:"
          cat added_lines.txt
          {
            echo 'fileoutput<<EOF'
            cat added_lines.txt
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Get OAuth Token
        id: get_token
        env:
          OAUTH_URL: https://accenture-sbg-asg.authentication.eu10.hana.ondemand.com/oauth/token
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
        run: |
          echo "ðŸ”‘ Requesting OAuth2 token..."
          response=$(curl -sS -X POST "$OAUTH_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            --data-urlencode "client_id=$OAUTH_CLIENT_ID" \
            --data-urlencode "client_secret=$OAUTH_CLIENT_SECRET")

          echo "ðŸ“¥ Raw response: $response"
          token=$(echo "$response" | jq -r '.access_token')
          if [ "$token" == "null" ] || [ -z "$token" ]; then
            echo "âŒ Failed to fetch access token"
            exit 1
          fi
          echo "âœ… Successfully retrieved access token"
          echo "token=$token" >> $GITHUB_OUTPUT

      - name: Call BTP CI IFlow
        id: step2
        run: |
          echo "${{ steps.step1.outputs.fileoutput }}"
          curl -v -i -X GET "https://accenture-sbg-asg.it-cpi024-rt.cfapps.eu10-002.hana.ondemand.com/http/SyncArtifactsDispatcher/GITHUB" \
               -H "Content-Type: application/text" \
               -H "Authorization: Bearer ${{ steps.get_token.outputs.token }}" \
               -d "${{ steps.step1.outputs.fileoutput }}"

      - name: Call Naming Convention Check IFlow
        id: step3
        run: |
          echo "${{ steps.step1.outputs.fileoutput }}"
          curl -v -i -X GET "https://accenture-sbg-asg.it-cpi024-rt.cfapps.eu10-002.hana.ondemand.com/http/NamingConventionCheckwithPDforGIT" \
               -H "Content-Type: application/text" \
               -H "Authorization: Bearer ${{ steps.get_token.outputs.token }}" \
               -d "${{ steps.step1.outputs.fileoutput }}"
